{% extends "base.html" %}

{% block page_header %}
<div class="row align-items-center mb-4 p-4 rounded-4 shadow-lg" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #06b6d4 100%);">
    <div class="col-12 text-center">
        <i class="bi bi-clock-history mb-2" style="font-size: 2.5rem; color: white;"></i>
        <h1 class="h2 mb-1 text-white fw-bold">Transaction History</h1>
        <p class="mb-0 text-white" style="opacity: 0.9;">Complete audit trail for all PCN movements</p>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- PCN Search -->
<div class="card border-0 shadow-lg mb-4 rounded-4" style="background: linear-gradient(to bottom right, #ffffff 0%, #f8fafc 100%);">
    <div class="card-body p-4">
        <form method="get" action="{{ url_for('pcn_history') }}" class="row g-4 align-items-end">
            <div class="col-md-5">
                <label for="pcn" class="form-label fw-bold mb-2" style="font-size: 1.1rem; color: #1e40af;">
                    <i class="bi bi-upc-scan me-2"></i>Enter PCN Number
                </label>
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-light border-2" style="border-color: #cbd5e1;">
                        <i class="bi bi-hash text-primary"></i>
                    </span>
                    <input type="number" class="form-control border-2" id="pcn" name="pcn"
                           value="{{ search_pcn }}" placeholder="e.g., 41124" autofocus
                           style="font-size: 1.3rem; font-weight: 600; border-color: #cbd5e1;">
                </div>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-lg w-100 shadow-sm"
                        style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); border: none; color: white; border-radius: 0.75rem; font-weight: 600; padding: 0.75rem;">
                    <i class="bi bi-search me-2"></i> View History
                </button>
            </div>
        </form>

        {% if pcn_info %}
        <!-- PCN Info Card -->
        <div class="mt-4">
            <div class="card border-2 shadow-sm" style="border-color: #3b82f6 !important; background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%); border-radius: 1rem;">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-1 text-center">
                            <i class="bi bi-box-seam-fill" style="font-size: 2.5rem; color: #1e40af;"></i>
                        </div>
                        <div class="col-md-11">
                            <h5 class="mb-1 text-primary fw-bold">Item Description</h5>
                            <h4 class="mb-2" style="color: #1e40af; font-weight: 700;">{{ pcn_info.item }}</h4>
                            <div class="row g-3">
                                <div class="col-auto">
                                    <span class="badge bg-white text-primary border border-primary shadow-sm px-3 py-2">
                                        <i class="bi bi-cpu me-1"></i> MPN: <strong>{{ pcn_info.mpn or 'N/A' }}</strong>
                                    </span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-white text-success border border-success shadow-sm px-3 py-2">
                                        <i class="bi bi-box me-1"></i> On Hand: <strong>{{ pcn_info.onhandqty }}</strong>
                                    </span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-white text-info border border-info shadow-sm px-3 py-2">
                                        <i class="bi bi-geo-alt me-1"></i> Location: <strong>{{ pcn_info.loc_to }}</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Results Section -->
{% if transactions %}
<!-- Stats Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm rounded-4" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);">
            <div class="card-body py-3">
                <div class="row text-center text-white">
                    <div class="col-md-4">
                        <i class="bi bi-list-check d-block mb-1" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 fw-bold">{{ transactions|length }}</h3>
                        <small style="opacity: 0.9;">Total Transactions</small>
                    </div>
                    <div class="col-md-4 border-start border-end border-white border-opacity-25">
                        <i class="bi bi-arrow-repeat d-block mb-1" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 fw-bold">{{ transactions|selectattr('trantype', 'equalto', 'STOCK')|list|length + transactions|selectattr('trantype', 'equalto', 'RESTOCK')|list|length }}</h3>
                        <small style="opacity: 0.9;">Stock Operations</small>
                    </div>
                    <div class="col-md-4">
                        <i class="bi bi-box-arrow-right d-block mb-1" style="font-size: 1.5rem;"></i>
                        <h3 class="mb-0 fw-bold">{{ transactions|selectattr('trantype', 'equalto', 'PICK')|list|length }}</h3>
                        <small style="opacity: 0.9;">Pick Operations</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Table -->
<div class="card border-0 shadow-lg rounded-4">
    <div class="card-header text-white border-0 py-3" style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); border-radius: 1rem 1rem 0 0;">
        <h5 class="mb-0 fw-bold"><i class="bi bi-journal-text me-2"></i>Transaction Timeline</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" style="font-size: 0.95rem;">
                <thead style="background: #f1f5f9;">
                    <tr>
                        <th class="py-3 px-4" style="border: none; color: #475569;">Tran Time</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">Tran</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">Item</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">MPN</th>
                        <th class="py-3 px-4 text-center" style="border: none; color: #475569;">Tran Qty</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">Loc From</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">Loc To</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">WO</th>
                        <th class="py-3 px-4" style="border: none; color: #475569;">PO</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in transactions %}
                    <tr style="{% if loop.index % 2 == 0 %}background: #f8fafc;{% endif %} border-left: 4px solid {% if txn.trantype == 'STOCK' %}#10b981{% elif txn.trantype == 'PICK' %}#f59e0b{% elif txn.trantype == 'RESTOCK' %}#06b6d4{% else %}#6b7280{% endif %};">
                        <td class="py-3 px-4">
                            {% if txn.tran_time %}
                                <small class="text-muted d-block">{{ txn.tran_time.split(' ')[0] }}</small>
                                <strong>{{ txn.tran_time.split(' ')[1:] | join(' ') }}</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <span class="badge shadow-sm {% if txn.trantype == 'STOCK' %}bg-success{% elif txn.trantype == 'PICK' %}bg-warning text-dark{% elif txn.trantype == 'RESTOCK' %}bg-info{% else %}bg-secondary{% endif %}"
                                  style="font-size: 0.85rem; min-width: 75px; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-weight: 600;">
                                <i class="bi {% if txn.trantype == 'STOCK' %}bi-plus-circle{% elif txn.trantype == 'PICK' %}bi-dash-circle{% elif txn.trantype == 'RESTOCK' %}bi-arrow-repeat{% else %}bi-arrow-left-right{% endif %} me-1"></i>
                                {{ txn.trantype or 'N/A' }}
                            </span>
                        </td>
                        <td class="py-3 px-4"><strong style="color: #1e40af;">{{ txn.item or '-' }}</strong></td>
                        <td class="py-3 px-4"><code style="background: #e0f2fe; color: #0369a1; padding: 0.35rem 0.6rem; border-radius: 0.375rem; font-size: 0.9rem;">{{ txn.mpn or '-' }}</code></td>
                        <td class="py-3 px-4 text-center">
                            <span class="badge bg-primary text-white shadow-sm" style="font-size: 1.1rem; padding: 0.5rem 1.25rem; border-radius: 0.5rem;">{{ txn.tranqty or 0 }}</span>
                        </td>
                        <td class="py-3 px-4">
                            <i class="bi bi-box-arrow-up-right me-1 text-muted"></i>{{ txn.loc_from or '-' }}
                        </td>
                        <td class="py-3 px-4">
                            <i class="bi bi-box-arrow-in-down-right me-1 text-muted"></i>{{ txn.loc_to or '-' }}
                        </td>
                        <td class="py-3 px-4">{{ txn.wo or '-' }}</td>
                        <td class="py-3 px-4">{{ txn.po or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% elif search_pcn %}
<div class="card border-0 shadow-lg rounded-4">
    <div class="card-body text-center py-5">
        <i class="bi bi-search" style="font-size: 4rem; color: #cbd5e1;"></i>
        <h4 class="mt-3 text-muted">No Results Found</h4>
        <p class="text-muted mb-0">No transaction history found for PCN <strong>{{ search_pcn }}</strong></p>
    </div>
</div>
{% else %}
<div class="card border-0 shadow-lg rounded-4" style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);">
    <div class="card-body text-center py-5">
        <i class="bi bi-search" style="font-size: 4rem; color: #3b82f6;"></i>
        <h4 class="mt-3" style="color: #1e40af;">Ready to Search</h4>
        <p class="text-muted mb-0">Enter a PCN number above to view its complete transaction history</p>
    </div>
</div>
{% endif %}

<style>
.table-responsive {
    max-height: 65vh;
    overflow-y: auto;
    border-radius: 0 0 1rem 1rem;
}

.table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #f1f5f9 !important;
}

.table tbody tr {
    transition: all 0.2s ease;
}

.table tbody tr:hover {
    background-color: #dbeafe !important;
    transform: translateX(4px);
    box-shadow: 0 2px 12px rgba(59, 130, 246, 0.15);
}

.form-control:focus {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25) !important;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4) !important;
}

.badge {
    transition: all 0.2s;
}
</style>
{% endblock %}
