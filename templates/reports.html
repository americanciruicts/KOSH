{% extends "base.html" %}

{% block extra_css %}
<style>
    @media print {
        /* Hide navigation, header, footer, and UI elements */
        nav,
        .navbar,
        .modern-navbar,
        .row.align-items-center.mb-4,
        footer,
        .btn,
        button,
        .progress,
        .dark-mode-toggle,
        .card.bg-primary,
        .card.bg-success,
        .card.bg-warning,
        .card.bg-danger,
        .card.bg-info,
        .card.text-center {
            display: none !important;
        }

        /* Hide stat card rows */
        .row.mb-4:has(.card.text-center) {
            display: none !important;
        }

        /* Show card headers in print as section titles */
        .card-header {
            display: block !important;
            background: none !important;
            border: none !important;
            padding: 0 0 10px 0 !important;
            margin-bottom: 15px !important;
            border-bottom: 2px solid #333 !important;
        }

        .card-header h5 {
            font-size: 18px !important;
            font-weight: bold !important;
            color: black !important;
            margin: 0 !important;
        }

        .card-header i {
            display: none !important; /* Hide icons */
        }

        /* Reset body styling */
        body {
            margin: 0 !important;
            padding: 20px !important;
            background: white !important;
            color: black !important;
        }

        /* Full width containers */
        .container {
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Card adjustments */
        .card {
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 30px !important;
            page-break-after: always !important; /* Each card on new page */
        }

        /* Remove page break after the last card */
        .card:last-of-type {
            page-break-after: auto !important;
        }

        .card-body {
            padding: 0 !important;
        }

        /* Add report title */
        body::before {
            content: "PCB Inventory Report";
            display: block;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: black;
        }

        /* Table styling */
        .table-responsive {
            overflow: visible !important;
        }

        table {
            width: 100% !important;
            border-collapse: collapse !important;
            page-break-inside: auto;
            margin-bottom: 30px;
        }

        thead {
            display: table-header-group;
        }

        tfoot {
            display: table-footer-group;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        /* Table cell styling */
        table th,
        table td {
            border: 1px solid #333 !important;
            padding: 10px !important;
            background-color: white !important;
            color: black !important;
            text-align: left;
        }

        /* Header styling */
        thead th {
            font-weight: bold !important;
            background-color: #e0e0e0 !important;
            border-bottom: 2px solid #000 !important;
        }

        /* Footer styling */
        tfoot td,
        tfoot th {
            font-weight: bold !important;
            border-top: 2px solid #000 !important;
            background-color: #f5f5f5 !important;
        }

        /* Remove badges but keep text */
        .badge {
            background: none !important;
            color: black !important;
            border: 1px solid #333 !important;
            padding: 2px 6px !important;
        }

        /* Hide progress bars */
        .progress {
            display: none !important;
        }

        /* Make sure percentage text is visible */
        .small {
            color: black !important;
        }

        /* Remove code background */
        code {
            background: none !important;
            color: black !important;
            border: none !important;
            padding: 0 !important;
        }

        /* Strong text visibility */
        strong {
            color: black !important;
        }
    }
</style>
{% endblock %}

{% block page_header %}
<div class="professional-header mb-5">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <div class="d-flex align-items-center gap-3 mb-2">
                <div class="header-icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <div>
                    <h1 class="mb-1" style="font-size: 2rem; font-weight: 600; color: var(--text-primary);">Reports & Analytics</h1>
                    <p class="text-muted mb-0" style="font-size: 0.95rem;">Inventory insights, audit trails, and performance metrics</p>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('inventory') }}" class="btn btn-outline-primary btn-lg">
                <i class="bi bi-table me-1"></i> View Inventory
            </a>
            <button class="btn btn-primary btn-lg shadow-sm" onclick="window.print()">
                <i class="bi bi-printer me-1"></i> Print Report
            </button>
        </div>
    </div>
</div>

<style>
.professional-header {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.header-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--brand-primary), var(--card-accent-2));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.75rem;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}
</style>
{% endblock %}

{% block content %}
<!-- Inventory Valuation Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                <h5 class="mb-0 text-white">
                    <i class="bi bi-currency-dollar"></i> Inventory Valuation
                </h5>
            </div>
            <div class="card-body">
                <div id="valuationContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading valuation data...</span>
                        </div>
                        <p class="text-muted mt-2">Loading inventory valuation...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Inventory Summary by Type & Location
                </h5>
            </div>
            <div class="card-body">
                {% if summary %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>PCB Type</th>
                                    <th>Location</th>
                                    <th>Jobs Count</th>
                                    <th>Total Quantity</th>
                                    <th>Average Qty/Job</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_qty = summary | sum(attribute='total_quantity') %}
                                {% for item in summary %}
                                <tr>
                                    <td>
                                        <span class="badge bg-{% if item.pcb_type == 'Bare' %}secondary{% elif item.pcb_type == 'Partial' %}warning{% elif item.pcb_type == 'Completed' %}info{% else %}success{% endif %} me-2">
                                            {{ item.pcb_type }}
                                        </span>
                                    </td>
                                    <td><code>{{ item.location }}</code></td>
                                    <td>{{ item.job_count }}</td>
                                    <td><strong>{{ '{:,}'.format(item.total_quantity) }}</strong></td>
                                    <td>{{ '{:.1f}'.format(item.average_quantity) }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress me-2" style="width: 100px; height: 20px;">
                                                {% set percentage = (item.total_quantity / total_qty * 100) if total_qty > 0 else 0 %}
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ percentage }}%" 
                                                     aria-valuenow="{{ percentage }}" 
                                                     aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <span class="small">{{ '{:.1f}%'.format(percentage) }}</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="2"><strong>Total:</strong></td>
                                    <td><strong>{{ summary | sum(attribute='job_count') }}</strong></td>
                                    <td><strong>{{ '{:,}'.format(total_qty) }}</strong></td>
                                    <td><strong>{{ '{:.1f}'.format((summary | sum(attribute='total_quantity')) / (summary | sum(attribute='job_count')) if (summary | sum(attribute='job_count')) > 0 else 0) }}</strong></td>
                                    <td><strong>100.0%</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-graph-down display-4 text-muted"></i>
                        <p class="text-muted mt-2">No summary data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Cards -->
{% if summary %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <i class="bi bi-briefcase display-4"></i>
                <h4 class="mt-2">{{ summary | map(attribute='job_count') | sum }}</h4>
                <p class="card-text">Total Jobs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <i class="bi bi-box-seam display-4"></i>
                <h4 class="mt-2">{{ '{:,}'.format(summary | map(attribute='total_quantity') | sum) }}</h4>
                <p class="card-text">Total Quantity</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <i class="bi bi-cpu display-4"></i>
                <h4 class="mt-2">{{ summary | map(attribute='pcb_type') | unique | list | length }}</h4>
                <p class="card-text">PCB Types</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <i class="bi bi-geo-alt display-4"></i>
                <h4 class="mt-2">{{ summary | map(attribute='location') | unique | list | length }}</h4>
                <p class="card-text">Locations</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Expiration Status Report -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-fill"></i> Expiration Status Report
                </h5>
            </div>
            <div class="card-body">
                <div id="expirationReport">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading expiration data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audit Trail -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> Recent Activity Log
                </h5>
                <span class="badge bg-secondary">Last 100 entries</span>
            </div>
            <div class="card-body">
                {% if audit_log %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Operation</th>
                                    <th>Job</th>
                                    <th>PCB Type</th>
                                    <th>Quantity Change</th>
                                    <th>New Qty</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in audit_log %}
                                <tr>
                                    <td class="text-muted small">
                                        {{ entry.timestamp if entry.timestamp else 'N/A' }}
                                    </td>
                                    <td>
                                        <span class="badge {% if entry.operation == 'STOCK' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ entry.operation }}
                                        </span>
                                    </td>
                                    <td><strong>{{ entry.job }}</strong></td>
                                    <td>
                                        <span class="badge bg-{% if entry.pcb_type == 'Bare' %}secondary{% elif entry.pcb_type == 'Partial' %}warning{% elif entry.pcb_type == 'Completed' %}info{% else %}success{% endif %} badge-sm">
                                            {{ entry.pcb_type }}
                                        </span>
                                    </td>
                                    <td class="{% if entry.quantity_change > 0 %}text-success{% else %}text-danger{% endif %}">
                                        {{ '+' if entry.quantity_change > 0 else '' }}{{ entry.quantity_change }}
                                    </td>
                                    <td>{{ entry.new_quantity }}</td>
                                    <td><code class="small">{{ entry.location or 'N/A' }}</code></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clock display-4 text-muted"></i>
                        <p class="text-muted mt-2">No audit log entries found</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-download"></i> Export Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="{{ url_for('api_inventory') }}" class="btn btn-outline-primary" target="_blank">
                                <i class="bi bi-file-code"></i> Export as JSON
                            </a>
                        </div>
                        <p class="small text-muted mt-1">Raw inventory data in JSON format</p>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-outline-success" onclick="exportToCSV()">
                                <i class="bi bi-file-spreadsheet"></i> Export as CSV
                            </button>
                        </div>
                        <p class="small text-muted mt-1">Spreadsheet-compatible format</p>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-primary fw-bold" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print Report
                            </button>
                        </div>
                        <p class="small text-muted mt-1">Print-friendly version</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load expiration report and valuation on page load
document.addEventListener('DOMContentLoaded', function() {
    loadExpirationReport();
    loadInventoryValuation();
});

function loadExpirationReport() {
    fetch('/api/inventory')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                generateExpirationReport(data.data);
            } else {
                showExpirationError('Failed to load inventory data');
            }
        })
        .catch(error => {
            console.error('Error loading expiration data:', error);
            showExpirationError('Error loading expiration data');
        });
}

function generateExpirationReport(inventory) {
    const expirationStats = {
        expired: [],
        critical: [],
        warning: [],
        fresh: [],
        unknown: []
    };

    let totalItems = 0;
    let totalQuantity = 0;

    // Calculate expiration status for each item
    inventory.forEach(item => {
        // Call the expiration API for each item
        const dc = item.dc;
        const pcbType = item.pcb_type;
        const msd = item.msd;

        if (dc) {
            fetch(`/api/expiration-check?dc=${encodeURIComponent(dc)}&pcb_type=${encodeURIComponent(pcbType)}&msd=${encodeURIComponent(msd || '')}`)
                .then(response => response.json())
                .then(expData => {
                    if (expData.success) {
                        const status = expData.expiration.status_text;
                        const itemData = {
                            ...item,
                            expiration: expData.expiration,
                            display_text: expData.display_text
                        };

                        expirationStats[status].push(itemData);
                        totalItems++;
                        totalQuantity += item.qty;

                        // Update display after processing all items
                        if (totalItems === inventory.filter(i => i.dc).length) {
                            displayExpirationReport(expirationStats, totalItems, totalQuantity);
                        }
                    }
                })
                .catch(error => console.error('Error checking expiration:', error));
        } else {
            expirationStats.unknown.push({...item, expiration: null, display_text: 'No date code'});
            totalItems++;
            totalQuantity += item.qty;
        }
    });

    // Handle case where no items have date codes
    setTimeout(() => {
        displayExpirationReport(expirationStats, totalItems, totalQuantity);
    }, 1000);
}

function displayExpirationReport(stats, totalItems, totalQuantity) {
    const container = document.getElementById('expirationReport');

    const expiredCount = stats.expired.length;
    const criticalCount = stats.critical.length;
    const warningCount = stats.warning.length;
    const freshCount = stats.fresh.length;
    const unknownCount = stats.unknown.length;

    const expiredQty = stats.expired.reduce((sum, item) => sum + item.qty, 0);
    const criticalQty = stats.critical.reduce((sum, item) => sum + item.qty, 0);
    const warningQty = stats.warning.reduce((sum, item) => sum + item.qty, 0);

    let html = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body">
                        <i class="bi bi-x-circle display-4"></i>
                        <h4 class="mt-2">${expiredCount}</h4>
                        <p class="card-text">Expired Items</p>
                        <small>${expiredQty.toLocaleString()} units</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle display-4"></i>
                        <h4 class="mt-2">${criticalCount}</h4>
                        <p class="card-text">Critical (< 1 month)</p>
                        <small>${criticalQty.toLocaleString()} units</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <i class="bi bi-info-circle display-4"></i>
                        <h4 class="mt-2">${warningCount}</h4>
                        <p class="card-text">Warning (< 6 months)</p>
                        <small>${warningQty.toLocaleString()} units</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-secondary text-white">
                    <div class="card-body">
                        <i class="bi bi-question-circle display-4"></i>
                        <h4 class="mt-2">${unknownCount}</h4>
                        <p class="card-text">No Date Code</p>
                        <small>Review needed</small>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Add detailed tables for expired and critical items
    if (expiredCount > 0 || criticalCount > 0) {
        html += `<h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> Items Requiring Immediate Attention</h6>`;
        html += `<div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Status</th>
                        <th>Job</th>
                        <th>PCB Type</th>
                        <th>Quantity</th>
                        <th>Date Code</th>
                        <th>Expiration Info</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>`;

        // Add expired items
        stats.expired.forEach(item => {
            html += `
                <tr class="table-danger">
                    <td><span class="badge bg-danger"><i class="bi bi-x-circle"></i> EXPIRED</span></td>
                    <td><strong>${item.job}</strong></td>
                    <td><span class="badge bg-secondary">${item.pcb_type}</span></td>
                    <td>${item.qty.toLocaleString()}</td>
                    <td><code>${item.dc || 'N/A'}</code></td>
                    <td>${item.display_text || 'Unknown'}</td>
                    <td><code>${item.location}</code></td>
                </tr>`;
        });

        // Add critical items
        stats.critical.forEach(item => {
            html += `
                <tr class="table-warning">
                    <td><span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle"></i> CRITICAL</span></td>
                    <td><strong>${item.job}</strong></td>
                    <td><span class="badge bg-secondary">${item.pcb_type}</span></td>
                    <td>${item.qty.toLocaleString()}</td>
                    <td><code>${item.dc || 'N/A'}</code></td>
                    <td>${item.display_text || 'Unknown'}</td>
                    <td><code>${item.location}</code></td>
                </tr>`;
        });

        html += `</tbody></table></div>`;
    }

    if (expiredCount === 0 && criticalCount === 0) {
        html += `
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i>
                <strong>Good news!</strong> No expired or critical inventory items found.
            </div>
        `;
    }

    container.innerHTML = html;
}

function showExpirationError(message) {
    const container = document.getElementById('expirationReport');
    container.innerHTML = `
        <div class="text-center py-3">
            <i class="bi bi-exclamation-triangle text-warning"></i>
            <p class="text-muted mt-2">${message}</p>
        </div>
    `;
}

// Inventory Valuation Functions
function loadInventoryValuation() {
    const container = document.getElementById('valuationContent');

    // Get today's date in YYYY-MM-DD format
    const today = new Date().toISOString().split('T')[0];

    // Fetch current valuation
    fetch(`/api/valuation/${today}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.snapshot) {
                displayValuation(data.snapshot);
            } else {
                // Try to get latest snapshot instead
                fetch('/api/valuation/snapshots')
                    .then(response => response.json())
                    .then(snapshotData => {
                        if (snapshotData.success && snapshotData.snapshots && snapshotData.snapshots.length > 0) {
                            const latestSnapshot = snapshotData.snapshots[0];
                            // Fetch that snapshot's detailed data
                            return fetch(`/api/valuation/${latestSnapshot.date}`);
                        } else {
                            throw new Error('No valuation snapshots available');
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.snapshot) {
                            displayValuation(data.snapshot);
                        } else {
                            showValuationError('No valuation data available. Please import pricing data.');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading valuation:', error);
                        showValuationError('No valuation data available. Please import pricing data.');
                    });
            }
        })
        .catch(error => {
            console.error('Error loading current valuation:', error);
            showValuationError('Error loading valuation data');
        });
}

function displayValuation(snapshot) {
    const container = document.getElementById('valuationContent');
    const totalValue = parseFloat(snapshot.total_value || 0);
    const totalQty = parseInt(snapshot.total_quantity || 0);
    const itemCount = parseInt(snapshot.item_count || 0);
    const avgValue = itemCount > 0 ? (totalValue / itemCount) : 0;

    const html = `
        <div class="row g-4 mb-4">
            <!-- Total Inventory Value -->
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <i class="bi bi-cash-stack display-4 text-success mb-2"></i>
                    <h3 class="text-success mb-1">$${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
                    <p class="text-muted mb-0 small">Total Inventory Value</p>
                </div>
            </div>

            <!-- Total Quantity -->
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <i class="bi bi-box-seam display-4 text-primary mb-2"></i>
                    <h3 class="text-primary mb-1">${totalQty.toLocaleString()}</h3>
                    <p class="text-muted mb-0 small">Total Units</p>
                </div>
            </div>

            <!-- Item Count -->
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <i class="bi bi-list-ul display-4 text-info mb-2"></i>
                    <h3 class="text-info mb-1">${itemCount}</h3>
                    <p class="text-muted mb-0 small">Unique Items</p>
                </div>
            </div>

            <!-- Average Value -->
            <div class="col-md-3">
                <div class="text-center p-3 bg-light rounded">
                    <i class="bi bi-graph-up display-4 text-warning mb-2"></i>
                    <h3 class="text-warning mb-1">$${avgValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
                    <p class="text-muted mb-0 small">Avg Value per Item</p>
                </div>
            </div>
        </div>

        <div class="alert alert-info mb-0">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <div>
                    <strong>Valuation Date:</strong> ${snapshot.date}<br>
                    <small class="text-muted">${snapshot.notes || 'Current inventory valuation'}</small>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
}

function showValuationError(message) {
    const container = document.getElementById('valuationContent');
    container.innerHTML = `
        <div class="alert alert-warning mb-0">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <div>
                    <strong>No Valuation Data</strong><br>
                    <small>${message}</small>
                </div>
            </div>
        </div>
    `;
}

// Export to CSV functionality
function exportToCSV() {
    fetch('/api/inventory')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const csv = convertToCSV(data.data);
                downloadCSV(csv, 'inventory_export.csv');
            } else {
                alert('Failed to export data');
            }
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Failed to export data');
        });
}

function convertToCSV(data) {
    const header = ['Job', 'PCB Type', 'Quantity', 'Location', 'Created At', 'Updated At'];
    const rows = data.map(item => [
        item.job,
        item.pcb_type,
        item.qty,
        item.location,
        item.created_at,
        item.updated_at
    ]);
    
    const csvContent = [header, ...rows]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Print styles
const printStyles = `
@media print {
    .btn, .card-header .badge, nav, footer { display: none !important; }
    .card { border: none !important; box-shadow: none !important; }
    .table { font-size: 12px; }
    h1, h2, h3, h4, h5 { color: black !important; }
}
`;

// Add print styles
const style = document.createElement('style');
style.textContent = printStyles;
document.head.appendChild(style);
</script>
{% endblock %}